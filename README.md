#  ETL-pipeline для построения отчетности продаж

## Описание

Этот проект реализует ETL-пайплайн для обработки и построения отчетов по продажам. Он извлекает данные из источников, преобразует их с помощью заданной бизнес-логики и загружает в целевую базу данных витрины, позволяя удобно анализировать продажи.

## Основные возможности

- Извлечение данных из MariaDB
- Сложные SQL-запросы с иерархиями и фильтрацией
- Обработка результатов с использованием pandas
- Загрузка обработанных данных в ClickHouse с поддержкой партиционирования и обновления
- Автоматизация с помощью Apache Airflow для ежедневного запуска

## Технологии и инструменты

- Python 3.x
- Apache Airflow (DAGs и операторы Python)
- MariaDB (источник данных)
- ClickHouse (хранилище данных)
- pandas (обработка данных)
- airflow_clickhouse_plugin (интеграция с ClickHouse)
- pendulum (работа с датами и таймзонами)
- Docker и Docker Compose (контейнеризация и оркестрация)

## Структура проекта

- `dags/` — Airflow DAGs с ETL процессами
- `docker/` — архивы файлов и образов для Docker контейнеров
- `scripts/` - SQL-скрипт с подробными комментариями, на основе которого создаётся витрина
- `README.md` — документация проекта

## Установка и запуск через Docker Compose

1. Клонируйте репозиторий:
git clone https://github.com/Alina-Bagaeva/Project_ETL-pipeline_for_building_sales_reports.git
cd Project_ETL-pipeline_for_building_sales_reports

2. Убедитесь, что у вас установлены Docker и Docker Compose.

3. Запустите сборку и поднятие сервисов:
docker-compose up -d

4. Проверьте состояние контейнеров:
docker-compose ps

5. Для остановки и удаления контейнеров, сети и томов выполните:
docker-compose down

## Второй вариант установки ClickHouse: на Ubuntu 24.04 LTS в Yandex Cloud

### Подготовка виртуальной машины

1. **Создание ВМ в Yandex Cloud:**
   * Зайдите в консоль управления Yandex Cloud
   * Нажмите кнопку создания новой виртуальной машины
   * Выберите образ **Ubuntu 24.04 LTS** из списка доступных ОС
   * Настройте необходимые параметры:
     * CPU (количество ядер)
     * RAM (объем памяти)
     * Размер диска
   * В настройках сети откройте порты **8123** и **9000** для доступа к ClickHouse

### Установка ClickHouse

1. **Обновление системы:**
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```

2. **Добавление репозитория ClickHouse:**
   ```bash
   sudo apt-get install apt-transport-https ca-certificates dirmngr
   sudo apt-key adv --keyserver keyserver.ubuntu.com --recv E0C56BD4
   echo "deb https://repo.clickhouse.com/deb/stable/ main/" | sudo tee /etc/apt/sources.list.d/clickhouse.list
   ```

3. **Установка компонентов ClickHouse:**
   ```bash
   sudo apt-get update
   sudo apt-get install clickhouse-server clickhouse-client
   ```

4. **Запуск и активация сервиса:**
   ```bash
   sudo systemctl start clickhouse-server
   sudo systemctl enable clickhouse-server
   ```

### Настройка безопасности

1. **Проверка статуса сервиса:**
   ```bash
   sudo systemctl status clickhouse-server
   ```

2. **Настройка файрвола:**
   ```bash
   sudo ufw allow 8123/tcp
   sudo ufw allow 9000/tcp
   sudo ufw enable
   ```

### Дополнительные проверки

* Проверьте статус службы:
  ```bash
  sudo systemctl status clickhouse-server
  ```

* Проверьте логи на наличие ошибок:
  ```bash
  sudo journalctl -u clickhouse-server -f
  ```

### Тестирование подключения

1. **Локальное тестирование:**
   ```bash
   clickhouse client
   ```

2. **Проверка портов:**
   ```bash
   sudo netstat -tulpn | grep clickhouse
   ```

После выполнения всех шагов ClickHouse должен быть успешно установлен и доступен для подключения через порты **8123** (HTTP) и **9000** (нативный протокол).

## Настройка

- Конфигурация подключения к MariaDB и ClickHouse задаётся в переменных окружения для контейнеров и в настройках Airflow.
- При необходимости измените параметры в `docker-compose.yml` или `.env` файлах.

## Описание DAG-ов

| Название DAG                        | Назначение                                                                                      | Особенности                                                                                         |
|-----------------------------------|------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------|
| mariadb_to_clickhouse_ROP1         | Формирование витрины данных за период от 2025-01-01 до 2025-07-31                               | Используется для исторической загрузки большого объема данных                                      |
| mariadb_to_clickhouse_ROP1_daily   | Ежедневное дополнение и обновление витрины данными за вчерашний день                           | Запускается регулярно (например, в 8:00 по Москве) для актуализации данных в ClickHouse             |

---

Таким образом, система ETL содержит два разных DAG-а, обеспечивающих как начальную загрузку данных, так и их ежедневное обновление, что является стандартной практикой при работе с аналитическими витринами.
## Контакты

Для вопросов и предложений контакты: kraeva.alina@mail.ru

---

*Этот README содержит инструкции по работе с Docker Compose для запуска проекта в контейнерах, ускоряя деплой и облегчая управление зависимостями.*
